name: iOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Find and Build Project
        env:
          SCHEME: "testecollectionview"  # Confirme se é esse o nome exato do seu scheme
        run: |
          # 1. Encontra o dispositivo
          DEVICE=$(xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | sed 's/ Simulator//')
          echo "📱 Usando dispositivo: $DEVICE"

          # 2. Encontra o arquivo do projeto (.xcodeproj)
          PROJECT_PATH=$(find . -name "*.xcodeproj" -maxdepth 1 -type d | head -1)
          if [ -z "$PROJECT_PATH" ]; then
              echo "❌ Nenhum arquivo .xcodeproj encontrado!"
              exit 1
          fi
          echo "🛠 Projeto encontrado em: $PROJECT_PATH"

          # 3. Build (ajuste o scheme se necessário)
          xcodebuild build-for-testing \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=$DEVICE"

      - name: Run Tests
        env:
          SCHEME: "testecollectionview"
        run: |
          DEVICE=$(xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | sed 's/ Simulator//')
          PROJECT_PATH=$(find . -name "*.xcodeproj" -maxdepth 1 -type d | head -1)
          
          xcodebuild test \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=$DEVICE"
