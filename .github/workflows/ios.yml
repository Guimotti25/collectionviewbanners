name: iOS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4' # Use a mesma versÃ£o que vocÃª usa localmente

      - name: Show environment info
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Build
        env:
          SCHEME: "testecollectionview"
        run: |
          # 1. Limpa possÃ­veis caches problemÃ¡ticos
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
          # 2. Seleciona dispositivo
          DEVICE=$(xcrun simctl list devices | grep -E 'iPhone.*?\(.*?\)' | grep -v unavailable | head -1 | awk -F '[()]' '{print $1}' | sed 's/ *$//g')
          echo "ðŸ“± Usando dispositivo: $DEVICE"

          # 3. Build com tratamento de erro robusto
          set -o pipefail && xcodebuild \
            -project "testecollectionview.xcodeproj" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=$DEVICE" \
            clean build-for-testing \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            | xcpretty
